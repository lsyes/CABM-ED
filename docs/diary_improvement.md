# 日记功能改进说明

## 改进概述

将日记功能从"显示完整对话"改进为"两级显示：总结列表 → 详细对话"，同时优化数据存储结构。

## 主要变化

### 1. 数据存储结构变化

#### 旧结构（user://diary/YYYY-MM-DD.jsonl）
```json
{
  "timestamp": "14:30:25",
  "messages": [
    {"speaker": "用户", "content": "你好"},
    {"speaker": "角色", "content": "你好呀"}
  ]
}
```

#### 新结构（user://diary/YYYY-MM-DD.jsonl）
```json
{
  "timestamp": "14:30:25",
  "summary": "用户和角色进行了简单的问候...",
  "conversation": "用户：你好\n角色：你好呀"
}
```

**优势**：
- 总结和详细对话关联存储，便于查询
- 取消了独立的 `permanent_memory.jsonl`，避免数据分散
- 数据结构更清晰，易于维护

### 2. 界面显示变化

#### 第一级：总结列表
- 显示当天所有对话的总结卡片
- 每个卡片显示：时间 + 总结预览（最多100字）
- 卡片可点击，进入详细视图

#### 第二级：详细对话
- 显示完整的总结内容
- 显示详细的对话记录
- 提供"返回"按钮回到总结列表

### 3. 代码改动

#### AIService (scripts/ai_service.gd)

**删除的函数**：
- `_save_full_conversation_to_diary()` - 旧的保存完整对话函数
- `_append_to_permanent_storage()` - 旧的永久存储函数

**新增的函数**：
- `_save_to_diary(summary, conversation_text)` - 保存总结和详细对话到日记

**修改的函数**：
- `_save_memory()` → `_save_memory_and_diary()` - 同时保存到存档和日记
- `_handle_summary_response()` - 调用新的保存函数
- `end_chat()` - 移除旧的日记保存调用

#### DiaryViewer (scripts/diary_viewer.gd)

**变量变化**：
```gdscript
# 删除
var current_messages: Array = []
var displayed_message_count: int = 0
const MESSAGES_PER_PAGE = 20

# 新增
var current_records: Array = []
var view_mode: String = "summary"
var current_detail_record: Dictionary = {}
```

**删除的函数**：
- `_display_more_messages()` - 旧的分页加载
- `_add_conversation_block()` - 旧的对话块显示

**新增的函数**：
- `_display_summary_list()` - 显示总结列表
- `_add_summary_card()` - 添加总结卡片
- `_on_summary_card_clicked()` - 点击总结卡片
- `_display_detail_view()` - 显示详细对话
- `_on_back_to_summary()` - 返回总结列表

**修改的函数**：
- `_load_date_content()` - 加载新格式的数据
- `_on_scroll_changed()` - 简化（不再需要分页）
- `_on_prev_date_pressed()` / `_on_next_date_pressed()` - 添加视图模式重置

## 使用流程

### 用户视角

1. **打开日记**
   - 在卧室场景点击日记按钮
   - 显示最新日期的总结列表

2. **浏览总结**
   - 看到当天所有对话的总结卡片
   - 每个卡片显示时间和总结预览

3. **查看详情**
   - 点击感兴趣的总结卡片
   - 进入详细视图，看到完整总结和对话

4. **返回列表**
   - 点击"返回"按钮
   - 回到总结列表继续浏览

5. **切换日期**
   - 使用前后按钮切换日期
   - 自动返回总结列表视图

### 数据流程

```
对话结束
    ↓
end_chat()
    ↓
_flatten_conversation() → 生成对话文本
    ↓
_call_summary_api() → 调用AI总结
    ↓
_handle_summary_response() → 接收总结
    ↓
_save_memory_and_diary() → 保存到存档和日记
    ↓
_save_to_diary() → 写入日记文件
    ↓
{
  "timestamp": "...",
  "summary": "...",
  "conversation": "..."
}
```

## 兼容性说明

### 旧数据迁移

如果用户已有旧格式的日记数据，需要手动迁移或保留两种格式共存：

**选项1：手动迁移**（推荐）
- 读取旧格式文件
- 为每条记录生成简单总结（如"对话记录"）
- 转换为新格式

**选项2：共存**
- DiaryViewer 同时支持两种格式
- 检测记录是否有 `summary` 字段
- 旧格式显示为"未总结的对话"

当前实现采用**选项2**，新旧数据可以共存，但旧数据不会显示总结。

## 性能优化

### 优势
- **减少渲染**：总结列表只显示卡片，不渲染完整对话
- **按需加载**：只在点击时才加载详细对话
- **取消分页**：总结列表通常不会太长，无需分页

### 内存占用
- 总结列表：每条记录约 100-200 字节
- 详细对话：按需加载，不常驻内存

## 未来扩展

### 可能的功能
1. **搜索功能**：在总结中搜索关键词
2. **标签系统**：为对话添加标签（如"日常"、"重要"）
3. **导出功能**：导出某天或某段时间的日记
4. **统计分析**：对话次数、情感趋势等
5. **收藏功能**：收藏重要的对话

### 技术改进
1. **数据库存储**：使用 SQLite 替代 JSONL
2. **全文搜索**：支持高效的内容搜索
3. **云端同步**：支持多设备同步
4. **图片附件**：支持在日记中添加图片

## 测试建议

### 功能测试
1. 进行多次对话，检查日记是否正确保存
2. 切换日期，检查数据是否正确加载
3. 点击总结卡片，检查详细视图是否正确显示
4. 返回总结列表，检查状态是否正确恢复

### 边界测试
1. 空日记（没有任何记录）
2. 单条记录
3. 大量记录（100+）
4. 超长总结（1000+ 字符）
5. 特殊字符（换行、引号等）

### 性能测试
1. 加载大量日期（365天）
2. 加载大量记录（每天100条）
3. 快速切换日期
4. 快速点击卡片

## 注意事项

1. **数据格式**：确保总结和对话文本正确转义
2. **错误处理**：文件读取失败时的降级处理
3. **UI响应**：点击卡片时的视觉反馈
4. **滚动位置**：切换视图时保持合理的滚动位置
5. **内存管理**：及时释放不需要的UI节点

## 总结

这次改进让日记功能更加实用和高效：
- **用户体验**：两级显示让信息层次更清晰
- **数据结构**：总结和详细对话关联存储，便于管理
- **性能优化**：按需加载，减少不必要的渲染
- **可扩展性**：为未来功能扩展打下基础
