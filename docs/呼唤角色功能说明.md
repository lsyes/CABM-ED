# 呼唤角色功能说明

## 功能概述
玩家可以在任何场景随时呼唤角色，即使角色不在当前场景。

## 使用方法
1. 点击屏幕右侧区域（右侧1/4）
2. 在弹出的场景菜单中，点击"📞 呼唤{角色名}"按钮
3. 系统会根据角色的回复意愿判断是否成功

## 功能逻辑

### 成功率计算
- 基础意愿值：100
- 成功率 = (基础意愿 + 当前回复意愿 - 100) / 100
- 成功率范围：0-1

### 成功时
- 如果角色在当前场景：直接触发对话（角色主动）
- 如果角色不在当前场景：
  1. 将角色场景改为用户所在场景
  2. 不显示移动字幕（因为是被呼唤来的）
  3. 触发对话（角色主动）
- 冷却时间：5秒

### 失败时
- 显示提示信息："{角色名}没有回应"
- 降低回复意愿：-5 到 0
- 冷却时间：15秒

## 对话触发

### 情况1：角色不在当前场景
- 触发类型：`called`
- AI提示词：`"现在，用户在{场景名}呼唤了你，你来到了用户面前，主动说点什么吧。"`
  - 例如：`"现在，用户在客厅呼唤了你，你来到了用户面前，主动说点什么吧。"`
- 对话模式：角色主动（角色先说第一句话）

### 情况2：角色已在当前场景
- 触发类型：`called_here`
- AI提示词：`"现在，用户呼唤了你，主动说点什么吧。"`
- 对话模式：角色主动（角色先说第一句话）
- 说明：不包含场景名，因为角色本来就在这里

## 技术实现

### 修改的文件
1. `scripts/scene_menu.gd`
   - 添加"呼唤角色"按钮
   - 添加 `character_called` 信号

2. `scripts/event_manager.gd`
   - 添加 `on_character_called()` 事件函数
   - 处理成功率计算和冷却时间

3. `config/ai_config.json`
   - 在 `trigger_contexts` 中添加 `"called"` 情况

4. `scripts/main.gd`
   - 连接 `character_called` 信号
   - 实现 `_on_character_called()` 处理函数
   - 实现 `_start_called_chat()` 和 `_move_character_to_current_scene()` 辅助函数

5. `scripts/chat_dialog.gd`
   - 修改 `show_dialog()` 函数以支持 `"called"` 和 `"called_here"` 模式

6. `scripts/prompt_builder.gd`
   - 修改 `_get_trigger_context()` 函数以支持场景名占位符替换
   - 自动检测 `{current_scene}` 占位符并替换为实际场景名

## 注意事项
- 呼唤功能有冷却时间，避免频繁呼唤
- 失败时会降低回复意愿，影响后续交互
- 角色被呼唤来时不会显示移动字幕
