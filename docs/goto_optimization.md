# AI控制角色移动优化文档

## 优化目标
缓解"AI控制角色移动过于频繁"的问题，通过引入回复意愿概率机制和冷却时间，让角色在高回复意愿时更倾向于留下继续对话。

## 优化前的逻辑
对话时，如果AI回复中包含有效的`goto`字段，对话完成后会直接结束对话并触发角色移动到新场景。

## 优化后的逻辑

### 冷却时间机制
- **冷却时长**：300秒（5分钟）
- **触发时机**：
  - 情况3（立即触发场景变化）时设置冷却
  - 情况2中用户点击"结束聊天"触发场景变化时设置冷却
- **冷却期间行为**：如果在冷却中接收到goto字段，直接抛弃并从历史记录中删除

### 两种处理情况
接收到有效的`goto`字段后，首先检查冷却时间，然后根据**回复意愿概率**选择处理方式：

#### 情况1：冷却中抛弃goto
- **触发条件**：goto在冷却时间内
- **行为**：
  - 直接抛弃`goto`字段
  - 从对话历史记录（上下文）中删除本次的`goto`字段
  - 切换到输入模式，等待用户继续对话
- **效果**：防止角色频繁移动

#### 情况2：暂存goto（回复意愿高时）
- **触发条件**：不在冷却中，且回复意愿成功率 >= 70%
- **行为**：
  - 暂存`goto`字段到`pending_goto`
  - 清除当前的`goto`字段
  - 切换到输入模式，等待用户操作
  - **在对话框右下角显示"{角色名}将前往{场景名}"的金黄色提示**
- **用户操作影响**：
  - 如果用户输入消息：放弃暂存的`goto`，隐藏提示，继续正常对话
  - 如果用户点击"结束聊天"：恢复`goto`字段，隐藏提示，设置冷却，触发场景变化
- **效果**：角色想离开但愿意等待，给用户挽留的机会

#### 情况3：立即触发（回复意愿低时）
- **触发条件**：不在冷却中，且回复意愿成功率 < 70%
- **行为**：
  - 按照原逻辑，直接结束对话并移动到新场景
  - 设置goto冷却时间
- **效果**：角色不想继续聊天，直接离开

### 回复意愿计算
使用与`on_chat_turn_end`事件相同的基准值（170）来计算成功率：
```gdscript
var base_willingness = 170
var success_chance = helpers.calculate_success_chance(base_willingness)
# success_chance = (170 + current_willingness - 100) / 100
```

- 当前回复意愿 >= 30 时，成功率 >= 70%（高回复意愿）
- 当前回复意愿 < 30 时，成功率 < 70%（低回复意愿）

## 实现细节

### 修改的文件

#### 1. `scripts/ai_response_parser.gd`
- 添加 `pending_goto: int` 变量用于暂存goto字段
- 在 `reset()` 方法中初始化 `pending_goto = -1`

#### 2. `scripts/ai_service.gd`
- 添加 `get_pending_goto() -> int`：获取暂存的goto值
- 添加 `set_pending_goto(goto_value: int)`：设置暂存的goto值
- 添加 `clear_pending_goto()`：清除暂存的goto
- 添加 `remove_goto_from_history()`：从对话历史中移除最后一条assistant消息的goto字段

#### 3. `scripts/chat_dialog.gd`
- **添加常量**：
  - `GOTO_COOLDOWN_DURATION = 300.0`：goto冷却时长（5分钟）
- **添加变量**：
  - `goto_cooldown_end_time: float`：goto冷却结束时间
  - `goto_notification_label: Label`：goto提示标签
- **修改 `_check_and_handle_goto()`**：
  - 返回值从 `bool` 改为 `String`（"immediate"/"pending"/"discarded"/"none"）
  - 首先检查冷却时间
  - 根据回复意愿概率选择处理方式
  - 情况2调用 `_show_goto_notification()` 显示提示
  - 情况3调用 `_set_goto_cooldown()` 设置冷却
- **修改 `_on_continue_clicked()`**：
  - 根据 `_check_and_handle_goto()` 的返回值执行不同的操作
- **修改 `_on_input_submitted()`**：
  - 用户输入消息时，检查并清除暂存的goto
  - 调用 `_hide_goto_notification()` 隐藏提示
- **修改 `_on_end_button_pressed()`**：
  - 用户点击"结束聊天"时，检查并恢复暂存的goto
  - 调用 `_hide_goto_notification()` 隐藏提示
  - 调用 `_set_goto_cooldown()` 设置冷却
- **新增函数**：
  - `_is_goto_on_cooldown() -> bool`：检查goto是否在冷却中
  - `_set_goto_cooldown()`：设置goto冷却时间
  - `_get_scene_name(scene_id: String) -> String`：根据场景ID获取场景名称
  - `_show_goto_notification(target_scene: String)`：显示goto提示信息
  - `_hide_goto_notification()`：隐藏goto提示信息

## 效果预期

### 移动频率大幅降低
- **原逻辑**：每次有goto字段都会触发移动（100%）
- **新逻辑**：
  - 冷却中：0%概率移动（情况1，直接抛弃）
  - 回复意愿高（>=30）且不在冷却中：0%概率立即移动（情况2，暂存等待用户操作）
  - 回复意愿低（<30）且不在冷却中：100%概率立即移动（情况3，设置冷却）
- **冷却机制**：成功移动后5分钟内不会再次移动

### 用户体验改善
1. **更自然的对话流程**：角色不会在聊得正开心时突然离开
2. **用户有控制权**：在情况2中，用户可以选择继续对话或让角色离开
3. **符合角色性格**：回复意愿低时角色会直接离开，符合"不想聊天"的状态
4. **视觉反馈**：情况2显示金黄色提示，用户清楚知道角色的意图
5. **防止频繁移动**：冷却机制确保角色不会在短时间内反复移动

## 测试建议

### 测试场景1：高回复意愿（情况2）
1. 设置回复意愿 >= 30
2. 触发包含goto字段的对话
3. 观察：
   - 切换到输入模式
   - 右下角显示金黄色提示："{角色名}将前往{场景名}"
   - 可以继续对话或结束聊天

### 测试场景2：低回复意愿（情况3）
1. 设置回复意愿 < 30
2. 确保不在冷却中
3. 触发包含goto字段的对话
4. 观察：
   - 对话结束，角色移动到新场景
   - 设置5分钟冷却时间

### 测试场景3：暂存goto的用户操作
1. 触发情况2（暂存goto，显示提示）
2. 测试两种操作：
   - **输入消息**：goto被放弃，提示消失，继续对话
   - **点击"结束聊天"**：goto被恢复，提示消失，角色移动，设置冷却

### 测试场景4：冷却机制
1. 触发一次成功的场景移动（情况3或情况2后点击结束聊天）
2. 在5分钟内再次触发包含goto字段的对话
3. 观察：
   - goto被直接抛弃
   - 从历史记录中删除
   - 对话继续，不显示提示

### 测试场景5：提示显示和隐藏
1. 触发情况2，观察提示淡入动画
2. 输入消息，观察提示淡出动画
3. 再次触发情况2，观察提示正确更新

## 调试信息
代码中添加了详细的打印信息，可以通过控制台观察：
- `ChatDialog: goto字段处理 - 回复意愿: X, 成功率: Y`
- `ChatDialog: goto在冷却中，抛弃goto字段`
- `ChatDialog: 回复意愿高，暂存goto字段`
- `ChatDialog: 回复意愿低，立即触发场景变化`
- `ChatDialog: 设置goto冷却时间，将在 300.0 秒后解除`
- `ChatDialog: 用户输入消息，放弃暂存的goto字段`
- `ChatDialog: 用户主动结束聊天，恢复暂存的goto字段`
- `ChatDialog: 显示goto提示 - {角色名}将前往{场景名}`
- `ChatDialog: 隐藏goto提示`

## 配置参数

### 可调整的常量
在 `scripts/chat_dialog.gd` 中：
- `GOTO_COOLDOWN_DURATION = 300.0`：goto冷却时长（秒），默认5分钟
  - 可根据实际需求调整，建议范围：180-600秒（3-10分钟）

### 回复意愿阈值
在 `_check_and_handle_goto()` 中：
- `base_willingness = 170`：基准回复意愿值
- `success_chance >= 0.7`：高回复意愿阈值（70%）
  - 当前回复意愿 >= 30 时触发情况2
  - 当前回复意愿 < 30 时触发情况3

## 视觉设计

### goto提示标签
- **位置**：对话框右下角
- **颜色**：金黄色 `Color(1.0, 0.8, 0.3)`
- **对齐**：右对齐，底部对齐
- **动画**：
  - 淡入：0.5秒，透明度从0到0.8
  - 淡出：0.3秒，透明度从0.8到0
- **文本格式**：`{角色名}将前往{场景名}`
