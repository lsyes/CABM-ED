# 对话日记功能说明

## 功能概述

对话日记功能会完整记录每一次对话的所有内容，按日期分类保存，并提供便捷的查看界面。

## 主要特性

### 1. 完整记录对话
- **每句话都记录**：不再只保存总结，而是保存每一句完整的对话内容
- **按日期分类**：每天的对话保存在独立的文件中（格式：YYYY-MM-DD.jsonl）
- **包含时间戳**：每次对话记录具体的开始时间
- **区分说话者**：清楚标记是用户还是角色说的话

### 2. 日记入口
- **隐藏的判定区域**：在卧室场景左下角有一个隐藏的点击区域（80x80像素）
- **点击显示选项**：点击判定区域后弹出选项菜单，包含"📖 日记"选项
- **类似场景切换**：设计参考右侧的场景切换功能，统一的交互体验
- **自动隐藏**：点击外部区域或选择选项后自动隐藏菜单

### 3. 日记查看界面
- **日期选择**：可以通过"前一天"/"后一天"按钮切换日期
- **分页加载**：每次只加载部分消息（默认20条），向上滚动时自动加载更多
- **最新优先**：默认显示最新日期，消息从旧到新排列
- **居中显示**：查看器在场景中央显示，大小为600x500

## 文件存储

### 存储位置
```
user://diary/
├── 2024-01-01.jsonl
├── 2024-01-02.jsonl
└── 2024-01-03.jsonl
```

### 文件格式（JSONL）
每行是一个JSON对象，代表一次对话：

```json
{
  "timestamp": "14:30:25",
  "messages": [
    {"speaker": "用户名", "content": "你好"},
    {"speaker": "角色名", "content": "你好！有什么我可以帮你的吗？"}
  ]
}
```

## 使用方法

### 查看日记
1. 进入卧室场景（bedroom）
2. 点击左下角的隐藏判定区域（会弹出选项菜单）
3. 点击"📖 日记"选项
4. 使用日期选择器切换不同日期
5. 向上滚动查看更早的对话
6. 点击"关闭"按钮退出

### 技术细节

#### 保存时机
- 对话结束时，在调用总结模型之前
- 先保存完整对话记录，再保存总结
- 确保即使总结失败，完整对话也已保存

#### 性能优化
- **分页加载**：避免一次性加载大量消息
- **按需读取**：只在打开日记时读取文件
- **JSONL格式**：便于追加和逐行读取

#### 与现有功能的关系
- **不影响总结功能**：总结模型仍然正常工作
- **不影响记忆系统**：中期记忆和永久存储仍然保存总结
- **独立存储**：日记文件独立于存档系统

## 代码结构

### 新增文件
- `scripts/diary_viewer.gd` - 日记查看器脚本
- `scripts/diary_button.gd` - 日记按钮脚本

### 修改文件
- `scripts/ai_service.gd` - 添加完整对话保存功能
- `scripts/main.gd` - 集成日记按钮和查看器
- `scripts/main.tscn` - 添加UI节点

### 关键函数

#### AIService
```gdscript
func _save_full_conversation_to_diary()
```
保存完整对话到日记文件

#### DiaryViewer
```gdscript
func show_diary()  # 显示日记查看器
func _load_date_content(date_str: String)  # 加载指定日期
func _display_more_messages()  # 分页加载更多消息
```

#### Main
```gdscript
func _update_diary_button_visibility()  # 更新判定区域状态
func _on_diary_selected()  # 处理日记选项选择
```

## 未来扩展

可能的改进方向：
- 搜索功能：按关键词搜索对话
- 导出功能：导出为文本或PDF
- 统计功能：显示对话次数、时长等
- 标签功能：为对话添加标签分类
- 情感分析：显示对话的情感倾向
