# 开场系统测试指南

## 快速测试步骤

### 1. 测试首次启动流程

#### 准备工作
删除现有存档（如果存在）：
- Windows: `%APPDATA%\Godot\app_userdata\CABM-ED\saves\save_slot_1.json`
- 或在游戏中按F12打开存档调试面板，点击"删除存档"

#### 测试流程
1. **启动游戏**
   - 应该看到开场故事场景（显示 index.png 背景图片）
   
2. **观看开场故事**
   - 文本应该逐字显示（打字机效果）
   - 共5段文本，每段之间有2秒间隔
   - 可以点击屏幕跳过当前文本的打字动画
   - 所有文本播放完后显示"继续"按钮

3. **点击继续按钮**
   - 进入初始设置场景

4. **填写初始设置**
   - **用户名**：输入你的名字（必填）
     - 如果不填写直接点击"开始游戏"，应该显示红色错误提示
   - **角色名**：默认为"雪狐"，可以修改
   - **API密钥**：可选，可以留空
   - 底部应该显示提示文字

5. **点击开始游戏**
   - 应该进入主游戏场景
   - 控制台应该输出：
     ```
     角色名称已保存: [你输入的角色名]
     初始存档已创建，用户名: [你输入的用户名], 角色名: [你输入的角色名]
     ```

6. **验证数据保存**
   - 检查 `config/app_config.json`，`character_name` 应该是你输入的角色名
   - 检查存档文件存在：`user://saves/save_slot_1.json`
   - 如果输入了API密钥，检查 `user://api_keys.json`

### 2. 测试再次启动

1. **关闭游戏**

2. **再次启动游戏**
   - 应该直接进入主游戏场景
   - 跳过开场故事和初始设置
   - 控制台应该输出：
     ```
     检测到存档，直接进入游戏
     ```

### 3. 测试跳过功能

1. **删除存档**

2. **启动游戏**

3. **在开场故事播放时**
   - 点击屏幕任意位置
   - 当前正在播放的文本应该立即完整显示
   - 继续等待下一段文本

### 4. 测试输入验证

1. **删除存档并启动游戏**

2. **在初始设置页面**
   - 不输入用户名，直接点击"开始游戏"
   - 应该显示红色错误提示："请输入你的名字"
   - 错误提示2秒后自动消失

3. **清空角色名**
   - 将角色名清空
   - 点击"开始游戏"
   - 应该使用默认值"雪狐"

### 5. 测试提前退出（v1.1新增）

#### 测试场景A：开场阶段退出
1. **删除存档**
2. **启动游戏**
3. **在开场故事播放时关闭游戏**
4. **再次启动游戏**
   - ✅ 应该再次播放开场故事
   - ✅ 不应该跳过开场
   - ✅ 检查存档文件不存在

#### 测试场景B：设置阶段退出
1. **删除存档**
2. **启动游戏，观看完开场**
3. **进入初始设置界面**
4. **不填写任何信息，直接关闭游戏**
5. **再次启动游戏**
   - ✅ 应该再次播放开场故事
   - ✅ 检查存档文件不存在

#### 测试场景C：部分填写后退出
1. **删除存档**
2. **启动游戏，进入设置界面**
3. **只填写用户名，不点击"开始游戏"**
4. **关闭游戏**
5. **再次启动**
   - ✅ 应该再次播放开场故事
   - ✅ 之前填写的信息不会保存

## 预期结果

### 首次启动
- ✅ 播放开场故事
- ✅ 显示初始设置界面
- ✅ 验证必填字段
- ✅ 保存用户数据
- ✅ 创建初始存档
- ✅ 进入主游戏

### 再次启动
- ✅ 跳过开场和设置
- ✅ 直接进入主游戏
- ✅ 加载已有存档

### 提前退出测试（v1.1新增）
- ✅ 在开场阶段退出不创建存档
- ✅ 在设置阶段退出不创建存档
- ✅ 只有完成设置后才创建存档
- ✅ 再次启动仍显示开场

## 常见问题

### Q: 开场故事不显示
**A**: 检查 `scenes/intro_scene.tscn` 是否正确创建

### Q: 初始设置界面布局错乱
**A**: 检查 `scenes/initial_setup.tscn` 的节点结构是否正确

### Q: 点击"开始游戏"后没有反应
**A**: 
1. 检查控制台是否有错误信息
2. 确认SaveManager已正确加载（在project.godot的autoload中）
3. 检查main.tscn路径是否正确

### Q: 再次启动仍然显示开场
**A**: 
1. 检查存档文件是否真的创建成功
2. 查看用户数据目录：`OS.get_user_data_dir()`
3. 确认存档路径：`user://saves/save_slot_1.json`
4. 确认是否完成了初始设置（点击了"开始游戏"按钮）

### Q: 在开场或设置阶段退出后，再次启动跳过了开场
**A**: 这个问题已在v1.1修复。如果仍然出现：
1. 检查SaveManager是否正确加载
2. 确认 `is_initial_setup_completed` 标志工作正常
3. 查看控制台输出

### Q: API密钥保存后在哪里查看
**A**: 
- 文件位置：`user://api_keys.json`
- 在游戏中：按F12打开AI配置面板查看

## 调试技巧

### 查看用户数据目录
在游戏中添加临时代码：
```gdscript
print("用户数据目录: ", OS.get_user_data_dir())
```

### 手动删除存档
```gdscript
# 在游戏中执行
DirAccess.remove_absolute("user://saves/save_slot_1.json")
```

### 检查存档是否存在
```gdscript
print("存档存在: ", FileAccess.file_exists("user://saves/save_slot_1.json"))
```

## 性能检查

- 开场故事文本动画应该流畅
- 场景切换应该无延迟
- 输入框应该响应灵敏
- 错误提示动画应该平滑

## 下一步

测试通过后，可以考虑：
1. 添加背景音乐
2. 添加背景图片（使用 `assets/images/index.png`）
3. 添加更多自定义选项
4. 优化UI样式和动画效果
