# UI 优化配置更改

## 更改日期
2025/10/13

## 更改内容

### 1. 侧边栏默认收起状态

**文件**: `scripts/sidebar.gd`

**更改**:
- 将 `is_expanded` 初始值从 `true` 改为 `false`
- 在 `_ready()` 函数中添加初始化代码，设置侧边栏为收起状态

**效果**:
- 进入游戏时，左侧边栏默认处于收起状态
- 用户可以点击展开按钮（▶）来展开侧边栏
- 这样可以给玩家更大的游戏视野

### 2. 默认开启自动调整时间

**文件**: 
- `scripts/sidebar.gd`
- `scripts/main.gd`

**更改**:
- 在 `sidebar.gd` 中：
  - 将 `auto_time_enabled` 初始值从 `false` 改为 `true`
  - 在创建自动时间勾选框时，设置 `button_pressed = true`
  - 在 `_ready()` 函数中，在构建UI之前就根据系统时间设置 `current_time_id`
- 在 `main.gd` 中：
  - 添加 `await get_tree().process_frame` 等待侧边栏初始化
  - 从侧边栏获取 `current_time_id` 和 `current_weather_id`，而不是硬编码 `"day"` 和 `"sunny"`

**效果**:
- 进入游戏时，"自动调整时间"选项默认勾选
- 游戏会根据系统时间自动调整场景的时间段（白天/黄昏/夜晚）
- **初始化时立即执行一次时间调整**，确保场景时间与系统时间同步
- 时间段映射规则：
  - 7:00-17:59 = 白天 (day)
  - 18:00-19:59 = 黄昏 (dusk)
  - 20:00-3:59 = 夜晚 (night)
  - 4:00-6:59 = 黄昏 (dusk)

**修复说明**:
- 在 `sidebar.gd` 的 `_ready()` 函数中，在构建UI之前先根据系统时间设置 `current_time_id`
- 在 `main.gd` 的 `_ready()` 函数中，等待侧边栏初始化完成后，从侧边栏获取当前的时间和天气设置
- 移除了硬编码的 `"day"` 和 `"sunny"`，改为使用 `sidebar.current_time_id` 和 `sidebar.current_weather_id`
- 这样可以确保场景加载时使用的是自动调整后的时间，而不是被硬编码覆盖
- 避免了需要手动切换场景才能触发自动时间的问题

### 3. 键盘顶起画面（移动端优化）

**文件**: 
- `project.godot`
- `export_presets.cfg`

**更改**:
- 在 `project.godot` 中添加 Android 键盘模式配置：`window/keyboard_mode=1`
- 在 `export_presets.cfg` 中添加屏幕键盘模式：`screen/keyboard_mode=1`

**效果**:
- 在移动设备上，当点击输入框弹出键盘时，整个画面会被向上推动
- 避免键盘遮挡输入框和对话内容
- 即使画面部分溢出屏幕顶部，也能确保输入区域可见

**键盘模式说明**:
- `0` = ADJUST_NOTHING（默认，键盘覆盖内容）
- `1` = ADJUST_RESIZE（调整窗口大小，推荐）
- `2` = ADJUST_PAN（平移窗口）

## 测试建议

### 测试侧边栏
1. 启动游戏
2. 确认左侧边栏处于收起状态（只显示一个窄条和展开按钮）
3. 点击展开按钮，确认侧边栏能正常展开
4. 点击收起按钮，确认侧边栏能正常收起

### 测试自动时间
1. 启动游戏
2. 展开侧边栏，确认"自动调整时间"选项已勾选
3. 观察场景时间段是否与当前系统时间匹配
4. 取消勾选，手动选择时间段，确认能正常切换
5. 重新勾选，确认自动时间功能恢复

### 测试键盘顶起（需要在真实移动设备上测试）
1. 在 Android 设备上安装并运行游戏
2. 触发聊天对话框
3. 点击输入框
4. 观察键盘弹出时，画面是否向上移动
5. 确认输入框和对话内容没有被键盘遮挡
6. 输入文字，确认功能正常
7. 关闭键盘，确认画面恢复正常位置

## 注意事项

1. **侧边栏状态不会保存**: 当前实现中，侧边栏的展开/收起状态不会保存到存档中，每次启动游戏都会重置为收起状态。如果需要保存状态，可以在 `SaveManager` 中添加相应字段。

2. **自动时间与手动选择**: 当用户手动选择时间段时，自动时间功能会自动关闭。这是为了避免用户选择被自动覆盖。

3. **自动时间初始化**: 修复了一个问题：之前虽然自动时间被勾选，但在启动时不会立即生效，需要等待时间变化或手动切换场景。现在在初始化时就会根据系统时间设置正确的时间段。

3. **键盘模式兼容性**: 
   - 键盘顶起功能主要针对 Android 平台
   - iOS 平台可能需要额外配置
   - 桌面平台不受影响
   - 建议在多个设备上测试以确保兼容性

4. **性能影响**: 这些更改对性能影响极小，不会影响游戏流畅度。

## 回滚方法

如果需要回滚这些更改：

### 回滚侧边栏默认状态
在 `scripts/sidebar.gd` 中：
```gdscript
var is_expanded: bool = true  # 改回 true
```
并删除 `_ready()` 函数中的初始化代码。

### 回滚自动时间
在 `scripts/sidebar.gd` 中：
```gdscript
var auto_time_enabled: bool = false  # 改回 false
```
并删除 `auto_checkbox.button_pressed = true` 这行。

### 回滚键盘模式
在 `project.godot` 中删除：
```
[android]

window/keyboard_mode=1
```

在 `export_presets.cfg` 中删除：
```
screen/keyboard_mode=1
```
