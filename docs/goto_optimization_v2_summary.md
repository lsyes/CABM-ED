# AI控制角色移动优化 V2 - 改进总结

## 改进内容

基于初版优化，进行了以下三项改进：

### 1. 取消情况1的概率触发
**改进前**：回复意愿高时，50%概率抛弃goto（情况1），50%概率暂存goto（情况2）

**改进后**：回复意愿高时，100%进入情况2（暂存goto，等待用户操作）

**理由**：
- 情况1直接抛弃goto，用户无感知，体验不够明确
- 情况2给用户选择权，体验更好
- 简化逻辑，减少随机性

### 2. 加入冷却时间机制
**冷却时长**：300秒（5分钟）

**触发时机**：
- 情况3（回复意愿低，立即触发场景变化）
- 情况2中用户点击"结束聊天"触发场景变化

**冷却期间行为**：
- 接收到goto字段时，直接抛弃并从历史记录中删除
- 不显示任何提示
- 对话正常继续

**效果**：
- 防止角色在短时间内频繁移动
- 即使AI频繁生成goto字段，也不会影响用户体验

### 3. 情况2显示提示信息
**提示内容**：`{角色名}将前往{场景名}`

**显示位置**：对话框右下角

**视觉样式**：
- 颜色：金黄色 `Color(1.0, 0.8, 0.3)`
- 对齐：右对齐，底部对齐
- 透明度：0.8

**动画效果**：
- 淡入：0.5秒
- 淡出：0.3秒

**显示时机**：
- 情况2（暂存goto）时显示

**隐藏时机**：
- 用户输入消息（放弃goto）
- 用户点击"结束聊天"（触发场景变化）

**效果**：
- 用户清楚知道角色的意图
- 提供明确的视觉反馈
- 增强用户的控制感

## 最终逻辑流程

```
接收到goto字段
    ↓
检查是否在冷却中？
    ├─ 是 → 抛弃goto，从历史删除，继续对话
    └─ 否 → 检查回复意愿
            ├─ 高（>=30）→ 情况2：暂存goto，显示提示，等待用户操作
            │                   ├─ 用户输入消息 → 放弃goto，隐藏提示
            │                   └─ 用户结束聊天 → 恢复goto，隐藏提示，设置冷却，触发移动
            └─ 低（<30）→ 情况3：立即触发场景变化，设置冷却
```

## 核心改进效果

### 移动频率控制
- **冷却机制**：5分钟内最多移动1次
- **回复意愿高**：不会立即移动，给用户选择权
- **回复意愿低**：立即移动，符合角色状态

### 用户体验提升
1. **明确的视觉反馈**：金黄色提示清楚告知角色意图
2. **完全的控制权**：用户可以选择挽留或放行
3. **防止频繁移动**：冷却机制确保稳定体验
4. **符合角色性格**：回复意愿低时直接离开，高时愿意等待

### 代码质量改进
1. **逻辑简化**：取消情况1，减少随机性
2. **功能完善**：添加冷却时间管理
3. **视觉增强**：添加提示信息显示
4. **可维护性**：清晰的函数划分和注释

## 配置建议

### 冷却时长调整
根据游戏节奏调整 `GOTO_COOLDOWN_DURATION`：
- **快节奏游戏**：180-240秒（3-4分钟）
- **中等节奏**：300秒（5分钟，默认）
- **慢节奏游戏**：420-600秒（7-10分钟）

### 回复意愿阈值调整
如果希望角色更容易移动，可以降低阈值：
- 当前：`success_chance >= 0.7`（回复意愿 >= 30）
- 更容易移动：`success_chance >= 0.8`（回复意愿 >= 80）
- 更难移动：`success_chance >= 0.6`（回复意愿 >= 10）

## 测试要点

1. **冷却机制**：验证5分钟内不会重复移动
2. **提示显示**：验证提示正确显示和隐藏
3. **用户操作**：验证输入消息和结束聊天的不同效果
4. **回复意愿**：验证高低回复意愿的不同行为
5. **场景名称**：验证场景名称正确显示（从scenes.json读取）

## 文件修改清单

- ✅ `scripts/ai_response_parser.gd` - 添加pending_goto变量
- ✅ `scripts/ai_service.gd` - 添加goto管理方法
- ✅ `scripts/chat_dialog.gd` - 核心逻辑改进
- ✅ `docs/goto_optimization.md` - 更新文档
- ✅ `docs/goto_optimization_v2_summary.md` - 新增改进总结
