# AI 配置系统升级文档

## 概述

侧边栏的 AI 配置部分已升级，从简单的密钥输入改为更灵活的配置系统。

## 主要变更

### 1. 侧边栏变更

**之前：**
- 直接在侧边栏显示密钥输入框
- 只能输入一个 API 密钥
- 保存按钮在侧边栏中

**现在：**
- 侧边栏只显示"AI 配置"按钮
- 显示当前配置状态（已配置/未配置）
- 点击按钮打开独立的配置面板

### 2. 配置面板

新增了独立的 AI 配置面板（`scenes/ai_config_panel.tscn`），包含两个选项卡：

#### 快速配置
- 只需填写一个 API 密钥
- 提示文字："填入硅基流动密钥"
- 使用默认的模型配置（来自 `ai_config.json`）
- 适合大多数用户

#### 详细配置
- 分为"对话模型"和"总结模型"两部分
- 每个模型需要配置：
  - 模型名称
  - Base URL
  - API 密钥
- 提示文字："注意：由于不同的协议，可能无法正常使用"
- 适合高级用户或使用自定义 API 的用户

### 3. 配置存储格式

**新格式（`user://ai_keys.json`）：**

简单模式：
```json
{
	"mode": "simple",
	"api_key": "sk-..."
}
```

详细模式：
```json
{
	"mode": "detailed",
	"chat_model": {
		"model": "deepseek-ai/DeepSeek-V3.2-Exp",
		"base_url": "https://api.siliconflow.cn/v1",
		"api_key": "sk-..."
	},
	"summary_model": {
		"model": "Qwen/Qwen3-8B",
		"base_url": "https://api.siliconflow.cn/v1",
		"api_key": "sk-..."
	}
}
```

**旧格式（`user://api_keys.json`）：**
```json
{
	"openai_api_key": "sk-..."
}
```

### 4. 兼容性

系统完全向后兼容：
- 如果存在旧格式配置文件，会自动识别并使用
- 配置面板会自动迁移旧配置到快速配置选项卡
- AIService 会优先加载新格式，找不到时回退到旧格式

## 文件变更

### 新增文件
- `scenes/ai_config_panel.tscn` - AI 配置面板场景
- `scripts/ai_config_panel.gd` - AI 配置面板脚本

### 修改文件
- `scripts/sidebar.gd` - 简化 AI 设置区域，改为按钮
- `scripts/ai_service.gd` - 支持新的配置格式加载

## 使用方法

### 用户操作流程

1. 点击侧边栏的"AI 配置"按钮
2. 选择配置方式：
   - **快速配置**：只填写硅基流动的 API 密钥
   - **详细配置**：自定义模型和 API 端点
3. 点击"保存配置"按钮
4. 配置会自动应用到 AI 服务

### 开发者注意事项

- 配置文件优先级：`user://ai_keys.json` > `user://api_keys.json`
- 详细模式会覆盖 `ai_config.json` 中的模型和 base_url 配置
- 简单模式只替换 API 密钥，其他配置使用默认值
- 配置面板关闭后会自动刷新侧边栏的状态显示

## 配置加载逻辑

AIService 的配置加载流程：

1. 尝试加载 `user://ai_keys.json`（新格式）
   - 如果是简单模式：使用默认配置 + 用户密钥
   - 如果是详细模式：使用用户自定义配置
2. 如果新格式不存在，尝试加载 `user://api_keys.json`（旧格式）
3. 如果都不存在，尝试从 `res://config/api_keys.json` 复制
4. 如果仍然失败，提示用户配置 AI 设置

## 测试建议

1. **新用户测试**：删除所有配置文件，测试首次配置流程
2. **旧用户测试**：保留旧的 `api_keys.json`，测试兼容性
3. **快速配置测试**：使用快速配置，验证默认模型是否正常工作
4. **详细配置测试**：使用详细配置，验证自定义模型是否生效
5. **配置切换测试**：在快速和详细配置之间切换，验证数据保存

## 未来改进建议

1. 添加配置验证功能（测试 API 连接）
2. 支持多个配置预设（快速切换不同的 API 提供商）
3. 添加配置导入/导出功能
4. 在详细配置中显示更多高级参数（temperature、max_tokens 等）
