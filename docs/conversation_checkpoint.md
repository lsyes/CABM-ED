# 对话断点保存功能说明

## 功能概述

改进了对话系统的上下文管理，实现了断点保存和恢复功能，提升了用户体验和数据可靠性。

## 主要改进

### 1. 实时保存对话

- **每条对话即时保存**：用户和AI的每条消息都会立即保存到临时文件 `user://temp_conversation.json`
- **包含时间戳**：每条消息都记录了发送时间（Unix时间戳）
- **自动持久化**：无需手动操作，系统自动管理

### 2. 断点恢复

- **启动时自动检测**：游戏启动时自动检查是否存在未完成的对话
- **自动总结**：如果检测到中断的对话，会自动发送给总结模型进行总结
- **保留原始时间**：总结后的记忆使用对话的原始时间戳，而不是当前时间
- **完成后清理**：总结完成后自动删除临时文件

### 3. 智能上下文管理

#### 部分清除策略
- 对话结束时只清除 **50%** 的上下文（向下取整，至少清除1条）
- 保留的上下文可以在下次对话时继续使用

#### 时间窗口机制
- 如果距上次对话时间 **小于5分钟**，继续携带保留的上下文
- 如果距上次对话时间 **超过5分钟**，清除全部上下文，重新开始

## 技术实现

### 临时文件结构

```json
{
  "conversation": [
    {
      "role": "user",
      "content": "消息内容",
      "timestamp": 1729670400
    },
    {
      "role": "assistant",
      "content": "{\"mood\": 1, \"msg\": \"回复内容\"}",
      "timestamp": 1729670405
    }
  ],
  "last_time": 1729670405,
  "is_first_message": false
}
```

### 关键函数

- `_save_temp_conversation()` - 保存当前对话到临时文件
- `_load_temp_conversation()` - 从临时文件加载对话
- `_delete_temp_conversation()` - 删除临时文件
- `_check_and_recover_interrupted_conversation()` - 检查并恢复中断的对话
- `_flatten_conversation_from_data()` - 从指定数据扁平化对话

## 使用场景

### 场景1：正常对话流程
1. 用户开始对话 → 消息保存到临时文件
2. AI回复 → 消息追加到临时文件
3. 用户结束对话 → 调用总结API
4. 总结完成 → 删除临时文件
5. 保留50%上下文供下次使用

### 场景2：意外中断
1. 用户正在对话
2. 游戏崩溃/强制关闭
3. 临时文件保留在磁盘
4. 下次启动游戏 → 自动检测到临时文件
5. 自动总结中断的对话 → 删除临时文件

### 场景3：连续对话
1. 用户结束对话（保留50%上下文）
2. 3分钟后再次对话 → 继续使用保留的上下文
3. 10分钟后再次对话 → 清除全部上下文，重新开始

## 配置参数

在 `config/ai_config.json` 中：

```json
{
  "memory": {
    "max_conversation_history": 10  // 携带的最大对话条数
  }
}
```

## 注意事项

1. 临时文件存储在 `user://` 目录，不会影响版本控制
2. 断点恢复在游戏启动时自动执行，无需用户干预
3. 5分钟的时间窗口是硬编码的，如需修改请在 `start_chat()` 函数中调整
4. 50%的清除比例是硬编码的，如需修改请在 `end_chat()` 函数中调整
