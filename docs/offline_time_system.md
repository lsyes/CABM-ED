# 离线时间系统

## 概述

离线时间系统会在玩家重新进入游戏时，根据离线时长自动调整角色的各项数值，使游戏更加真实。

## 功能说明

### 时间计算

系统会在游戏加载时自动计算：
- 当前时间
- 上次游玩时间（从存档中读取）
- 离线时长

### 数值调整规则

根据离线时长，系统会应用不同的调整：

#### 1. 小于5分钟
- **无任何变化**

#### 2. 5分钟 ~ 3小时
- **心情变化**：从所有心情中随机选择（平静权重最高）
- **回复意愿**：随机增加 -30 ~ 30

#### 3. 3小时 ~ 24小时
- **心情变化**：从所有心情中随机选择（平静权重最高）
- **好感度**：随机增加 -20 ~ 10
- **回复意愿**：随机增加 0 ~ 50

#### 4. 24小时以上
- **心情变化**：从所有心情中随机选择（平静权重最高）
- **好感度**：随机增加 -50 ~ 0
- **回复意愿**：随机**置为** 70 ~ 100

### 心情变化机制

心情变化采用加权随机：
- **平静**：权重为 5
- **其他心情**（开心、难过、生气、惊讶、害怕、厌恶）：权重各为 1

这意味着角色更容易回到平静状态。

## 技术实现

### 文件结构

```
scripts/
  ├── offline_time_manager.gd    # 离线时间管理器（自动加载）
  ├── save_manager.gd            # 存档管理器（已修改）
  └── offline_time_test.gd       # 测试脚本
```

### 自动加载顺序

在 `project.godot` 中的加载顺序：
1. SaveManager
2. OfflineTimeManager（新增）
3. 其他管理器...

### 时间戳存储

时间戳存储在存档的 `timestamp` 字段中：
```json
{
  "timestamp": {
    "created_at": "2025-10-14T10:30:00",
    "last_saved_at": "2025-10-14T15:45:30",
    "last_played_at": "2025-10-14T15:45:30",
    "last_played_at_unix": 1760444509.648
  }
}
```

- `created_at`：存档创建时间（字符串格式，便于阅读）
- `last_saved_at`：最后保存时间（字符串格式）
- `last_played_at`：最后游玩时间（字符串格式，便于阅读）
- `last_played_at_unix`：最后游玩时间（Unix时间戳，用于精确计算离线时长）

**注意**：系统优先使用 `last_played_at_unix` 进行计算，以避免时区和格式解析问题。如果该字段不存在（旧存档），会尝试解析 `last_played_at` 字符串。

## 测试方法

### 方法1：使用测试脚本

1. 将 `offline_time_test.gd` 添加到场景中
2. 在 Godot 控制台中调用测试函数：

```gdscript
# 测试1小时离线
$OfflineTimeTest.test_short_offline()

# 测试12小时离线
$OfflineTimeTest.test_medium_offline()

# 测试3天离线
$OfflineTimeTest.test_long_offline()

# 重置时间
$OfflineTimeTest.reset_time()
```

### 方法2：手动测试

1. 正常进入游戏，查看当前数值
2. 退出游戏（会自动保存）
3. 手动修改存档文件中的 `last_played_at` 时间
4. 重新进入游戏，观察数值变化

存档位置：`user://saves/save_slot_1.json`

### 方法3：真实测试

1. 正常进入游戏
2. 退出游戏
3. 等待一段时间（5分钟、3小时、24小时等）
4. 重新进入游戏，观察数值变化

## 调试信息

系统会在控制台输出详细的调试信息：

```
离线时长: 65.50 分钟 (1.09 小时)
离线时间 5分钟~3小时
心情变化: calm -> happy
回复意愿变化: 50 -> 65 (变化: +15)
```

## 注意事项

1. **首次进入游戏**：如果是首次进入游戏（没有存档），系统不会应用任何变化
2. **时间同步**：系统使用系统时间，确保设备时间准确
3. **数值范围**：
   - 好感度：无上下限
   - 回复意愿：0 ~ 100
   - 心情：从配置文件中的心情列表选择
4. **保存时机**：每次数值变化都会自动保存（如果启用了即时保存）

## 配置文件

### 心情配置
位置：`config/mood_config.json`

包含所有可用的心情状态，系统会从中随机选择。

### 存档模板
位置：`config/save_data_template.json`

定义了存档的数据结构，包括时间戳字段。

## 扩展建议

如果需要更复杂的离线机制，可以考虑：

1. **基于好感度的差异化**：高好感度时离线惩罚更小
2. **季节/节日影响**：特定日期有特殊的离线奖励
3. **离线事件**：长时间离线后触发特殊对话
4. **离线通知**：显示离线期间发生的变化
5. **离线上限**：设置离线时长上限，避免过度惩罚

## 相关文件

- `scripts/offline_time_manager.gd` - 核心逻辑
- `scripts/save_manager.gd` - 存档管理
- `config/mood_config.json` - 心情配置
- `config/save_data_template.json` - 存档模板
