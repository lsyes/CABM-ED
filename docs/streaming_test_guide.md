# 流式JSON响应测试指南

## 测试前准备

1. 确保 `config/ai_config.json` 中的 `system_prompt` 已更新为JSON格式
2. 确保API密钥已配置在 `user://api_keys.json`
3. 确保网络连接正常

## 测试步骤

### 1. 基本流式响应测试

1. 启动游戏
2. 进入对话界面
3. 发送一条简单消息，如"你好"
4. 观察：
   - 消息是否逐字显示（打字机效果）
   - 显示速度是否受控制（不会瞬间全部显示）
   - 是否能看到流式接收的效果

### 2. 长消息测试

1. 发送一条会触发长回复的消息
2. 观察：
   - Buffer机制是否正常工作
   - 即使AI快速返回，显示速度是否保持恒定
   - 所有内容是否完整显示

### 3. 多轮对话测试

1. 进行多轮对话（3-5轮）
2. 点击"结束"按钮
3. 检查日志文件 `user://ai_logs/log.txt`：
   - 对话历史是否包含完整JSON
   - 总结请求是否只包含msg内容

### 4. 错误处理测试

1. 断开网络连接
2. 尝试发送消息
3. 观察错误提示是否正常显示

## 查看日志

### Windows
运行 `view_ai_log.bat` 或手动打开：
```
%APPDATA%\Godot\app_userdata\CABM-ED\ai_logs\log.txt
```

### 日志内容检查

**对话请求日志**
- 应包含 `"stream": true`
- system_prompt应包含JSON格式说明

**对话响应日志**
- 应包含完整的JSON字符串
- 包含所有字段：mood, msg, will, like

**总结请求日志**
- 用户消息应该是原始文本
- 角色消息应该只包含msg字段内容（不是完整JSON）

## 预期行为

### 正常流式响应
```
1. 用户发送消息
2. 界面切换到回复模式
3. 角色名称显示
4. 消息逐字显示（打字机效果）
5. 显示完成后出现"点击继续"提示
6. 点击后切换回输入模式
```

### Buffer工作原理
```
接收: "你" → Buffer: "你", 显示: ""
接收: "好" → Buffer: "你好", 显示: "你"
接收: "啊" → Buffer: "你好啊", 显示: "你好"
...
流式结束 → 继续显示直到Buffer全部输出
```

## 常见问题

### 问题1: 消息瞬间全部显示
- 检查 `TYPING_SPEED` 是否设置正确
- 检查 `typing_timer` 是否正常启动

### 问题2: 消息不显示或显示不完整
- 检查 `_extract_msg_from_buffer()` 是否正确提取
- 查看日志中的完整响应
- 检查转义字符处理

### 问题3: 连接失败
- 检查API密钥
- 检查网络连接
- 查看日志中的错误信息

### 问题4: JSON解析错误
- 检查模型是否按要求返回JSON格式
- 查看日志中的原始响应
- 可能需要调整system_prompt
- 检查是否有 ```json``` 包裹（代码已自动处理）

### 问题5: 提取的字段为空
- 查看Godot控制台的调试输出
- 检查 "流式响应完成，完整内容" 输出
- 确认JSON格式是否正确
- 检查是否有 ```json``` 包裹

## 调试技巧

### 查看调试输出
代码中已经添加了调试输出，运行游戏时在Godot控制台查看：
- "接收到内容块: ..." - 每次接收到流式数据
- "发送新内容: ..." - 每次发送新内容到UI
- "流式响应完成，完整内容: ..." - 流式结束时的完整响应
- "提取的字段: ..." - 提取的mood, will, like字段

### 监控流式状态
在 `chat_dialog.gd` 中添加：
```gdscript
func _on_ai_response(response: String):
    print("Received chunk: ", response.length(), " chars")
    print("Buffer size: ", display_buffer.length())
    # ... 其余代码
```

## 性能监控

- 观察CPU使用率（`_process()` 持续运行）
- 检查内存使用（buffer大小）
- 测试长时间对话的稳定性
