# 日记功能测试指南

## 测试前准备

1. 确保游戏可以正常运行
2. 确保AI配置正确，可以进行对话
3. 清空或备份现有的日记文件（如果有）：`user://diary/`

## 测试步骤

### 1. 测试对话记录保存

**步骤：**
1. 启动游戏
2. 在任意场景与角色进行对话
3. 进行至少3轮对话（你说一句，角色回一句算一轮）
4. 点击"结束聊天"

**预期结果：**
- 控制台输出："完整对话已保存到日记: YYYY-MM-DD"
- 在 `user://diary/` 目录下生成当天日期的 `.jsonl` 文件

**验证方法：**
```bash
# Windows
type %APPDATA%\Godot\app_userdata\[项目名]\diary\*.jsonl

# 或使用游戏内的批处理文件查看
view_ai_log.bat
```

### 2. 测试日记入口显示

**步骤：**
1. 切换到不同场景（客厅、浴室等）
2. 尝试点击左下角区域
3. 切换到卧室场景
4. 点击左下角的隐藏判定区域

**预期结果：**
- 在非卧室场景：点击左下角无反应
- 在卧室场景：点击左下角弹出选项菜单
- 选项菜单包含"📖 日记"按钮
- 菜单有展开/收起动画

### 3. 测试日记查看器

**步骤：**
1. 在卧室场景点击"📖 日记"按钮
2. 观察日记查看器是否正确显示
3. 检查日期是否正确（应该是今天）
4. 检查对话内容是否完整显示

**预期结果：**
- 日记查看器在屏幕中央弹出
- 显示今天的日期
- 显示之前进行的对话内容
- 每次对话有时间戳
- 对话内容按时间从旧到新排列

### 4. 测试日期切换

**步骤：**
1. 打开日记查看器
2. 点击"前一天"按钮
3. 点击"后一天"按钮

**预期结果：**
- 如果只有今天的记录：
  - "前一天"按钮应该是禁用状态
  - "后一天"按钮应该是禁用状态
- 如果有多天记录：
  - 可以正常切换日期
  - 内容随日期变化

### 5. 测试分页加载

**步骤：**
1. 进行多次对话（建议至少25次，超过默认的20条限制）
2. 打开日记查看器
3. 滚动到顶部

**预期结果：**
- 初始只显示最新的20条对话记录
- 滚动到顶部时自动加载更多
- 控制台输出："已显示 X / Y 条记录"
- 滚动位置保持稳定（不会跳动）

### 6. 测试窗口大小调整

**步骤：**
1. 打开日记查看器
2. 调整游戏窗口大小
3. 观察日记查看器和按钮的位置

**预期结果：**
- 日记按钮始终在场景左下角
- 日记查看器始终在场景中央
- 不会超出场景范围

### 7. 测试多天记录

**步骤：**
1. 修改系统日期到明天（或等到第二天）
2. 进行新的对话
3. 打开日记查看器
4. 使用日期切换功能

**预期结果：**
- 默认显示最新日期（今天）
- 可以切换到昨天查看旧记录
- 每天的记录独立显示

## 常见问题排查

### 问题1：日记入口不工作
**检查：**
- 是否在卧室场景？
- 是否点击了左下角的判定区域（80x80像素）？
- 控制台是否有错误信息？
- `diary_button` 节点是否正确添加到场景？

### 问题2：日记文件未生成
**检查：**
- 是否完成了完整的对话（包括结束聊天）？
- 控制台是否输出"完整对话已保存到日记"？
- `user://diary/` 目录是否存在？
- 是否有文件写入权限？

### 问题3：日记内容显示不正确
**检查：**
- 打开 `.jsonl` 文件检查格式是否正确
- 是否有JSON解析错误？
- 角色名和用户名是否正确？

### 问题4：分页加载不工作
**检查：**
- 是否有足够多的对话记录（>20条）？
- 滚动条是否滚动到顶部？
- 控制台是否有加载消息？

## 性能测试

### 大量数据测试
1. 生成100+条对话记录
2. 打开日记查看器
3. 观察加载速度和流畅度

**预期：**
- 初始加载应该很快（只加载20条）
- 滚动加载应该流畅无卡顿
- 内存占用合理

### 长期使用测试
1. 连续使用30天
2. 每天进行多次对话
3. 定期检查文件大小和性能

**预期：**
- 文件大小增长合理
- 查看器性能不下降
- 日期列表正确排序

## 调试技巧

### 查看日记文件
```bash
# Windows
cd %APPDATA%\Godot\app_userdata\[项目名]\diary
dir
type 2024-01-01.jsonl
```

### 查看控制台输出
关键日志信息：
- "完整对话已保存到日记: YYYY-MM-DD"
- "找到 X 个日期的日记"
- "加载了 X 条对话记录"
- "已显示 X / Y 条记录"

### 手动测试数据
可以手动创建测试数据：
```json
{"timestamp":"10:00:00","messages":[{"speaker":"测试用户","content":"测试消息1"},{"speaker":"测试角色","content":"测试回复1"}]}
{"timestamp":"11:00:00","messages":[{"speaker":"测试用户","content":"测试消息2"},{"speaker":"测试角色","content":"测试回复2"}]}
```

保存为 `user://diary/2024-01-01.jsonl` 进行测试。
